# OrionEventsToTelegram

Сервис для пересылки событий из почты в Telegram с поддержкой фильтрации по сотрудникам и современной системой авторизации.

**Версия:** 3.3.1

## Быстрый старт

### Windows (рекомендуется)
1. Клонируйте репозиторий и перейдите в папку проекта
2. Запустите `run.bat` для автоматической установки и запуска
3. При первом запуске настройте токен и администраторов в файле `config.ini`
4. Запустите `run.bat` снова для старта приложения

### Ручная установка
1. Клонируйте репозиторий и перейдите в папку проекта.
2. Создайте виртуальное окружение в папке `app/`:
   ```bash
   cd app
   python -m venv .venv
   .venv\Scripts\activate
   pip install -r requirements.txt
   cd ..
   ```
3. Скопируйте `config.example.ini` в `config.ini` и настройте:
   ```bash
   cp config.example.ini config.ini
   ```
   Затем отредактируйте `config.ini`:
   ```ini
   [Telegram]
   bot_token = ваш_токен_бота_здесь
   
   [Admins]
   admin_ids = 123456789,987654321
   
   [Database]
   db_path = db/users.db
   
   [Paths]
   authorized_users_file = db/authorized_users.txt
   user_filters_file = db/user_filters.txt
   ```
4. Запустите приложение:
   ```bash
   cd app
   python main.py
   ```

## Миграция с версии 2.x

Если у вас есть данные в старом формате (файлы txt), выполните миграцию:

```bash
python migrations/migrate_to_sqlite.py
```

Скрипт автоматически:
- Проверит наличие файлов для миграции
- Создаст резервные копии старых файлов
- Перенесет данные в SQLite базу
- Покажет сводку мигрированных данных

**Примечание**: Если старых файлов нет, приложение автоматически создаст базу данных при первом запуске.

## BAT файлы для Windows

- **`run.bat`** — Автоматическая установка, проверка зависимостей и запуск приложения

## Структура проекта
```
OrionEventsToTelegram/
├── app/                    # Основная папка приложения
│   ├── .venv/             # Виртуальное окружение
│   ├── main.py            # Основной код приложения
│   ├── config.py          # Конфигурация
│   ├── user_manager.py    # Управление пользователями
│   ├── requirements.txt   # Зависимости
│   └── tests/             # Тесты
├── db/                    # Папка с данными
│   ├── users.db          # SQLite база данных
│   ├── authorized_users.txt (устаревший)
│   └── user_filters.txt (устаревший)
├── log/                   # Папка с логами
│   ├── YYYYMMDD_app.log  # Лог файлы по датам
│   └── .gitkeep          # Для отслеживания папки в Git
├── migrations/            # Скрипты миграции
│   ├── migrate_to_sqlite.py
│   └── README.md
├── config.example.ini     # Пример конфигурации
├── VERSION                # Файл версии
├── CHANGELOG.md           # История изменений
└── run.bat                # Скрипт запуска и установки
```

## Конфигурация
Файл `config.ini` содержит настройки:
- `[Telegram]` — настройки Telegram бота
- `[Admins]` — ID администраторов (через запятую)
- `[Database]` — путь к SQLite базе данных
- `[Paths]` — пути к файлам данных (для обратной совместимости)
- `[Logging]` — настройки логирования

### Логирование

Система логирования записывает события в файлы `log/YYYYMMDD_app.log` с ротацией по дате:

- **Формат файлов**: `YYYYMMDD_app.log` (например: `20250713_app.log`)
- **Ротация**: каждый день новый файл
- **Перезапуск**: при перезапуске бота в тот же день файл дополняется
- **Очистка**: автоматическое удаление старых файлов (настраивается в `config.ini`)
- **Количество дней**: настраивается в `config.ini` (по умолчанию 5 дней)
- **Кодировка**: UTF-8
- **Формат**: `время - уровень - сообщение`

#### Настройки в `config.ini`:
```ini
[Logging]
# Уровень логирования: DEBUG, INFO, WARNING, ERROR
level = INFO
# Количество дней для хранения логов
backup_logs_count = 5
```

Уровни логирования:
- `DEBUG` — вся информация (для разработки)
- `INFO` — основная информация (по умолчанию)
- `WARNING` — только предупреждения и ошибки
- `ERROR` — только ошибки

Логи также выводятся в консоль с цветовой подсветкой.

## Команды Telegram

### Для пользователей
- `/auth` — запрос на авторизацию
- `/filter {текст}` — установка фильтра по фамилии сотрудника
- `/unfilter` — удаление фильтра

### Для администраторов
- `/add_user {id}` — добавление пользователя вручную
- `/list_users` — список всех авторизованных пользователей
- `/update_menu` — принудительное обновление бургер-меню

## Система авторизации

### Новая логика (v3.0)
1. Пользователь отправляет `/auth`
2. Администраторы получают уведомление с inline-клавиатурой
3. Администратор одобряет или отклоняет запрос
4. Пользователь получает уведомление о результате

### Администрирование
- Администраторы настраиваются в `config.ini` в секции `[Admins]`
- ID администраторов указываются через запятую
- Только администраторы могут одобрять запросы и добавлять пользователей

## Функционал
- ✅ Современная система авторизации с SQLite
- ✅ Административное управление через inline-клавиатуры
- ✅ Фильтрация уведомлений по фамилии сотрудника
- ✅ Цветное логирование событий
- ✅ Поддержка Windows с корректным отображением русского языка
- ✅ Автоматическая миграция данных из старых версий
- ✅ Умное бургер-меню с автоматической установкой для авторизованных пользователей
- ✅ Многоязычная поддержка команд (русский/английский)

## База данных

Приложение использует SQLite базу данных (`db/users.db`) со следующими таблицами:

- **authorized_users** — авторизованные пользователи
- **auth_requests** — запросы на авторизацию
- **user_filters** — фильтры пользователей

---

Если возникнут вопросы — пишите! 